@inject IJSRuntime JsRuntime
@implements IAsyncDisposable

@ChildContent

@code {

    [Parameter]
    public required RenderFragment ChildContent { get; set; }

    [Parameter]
    public required string ObserverTargetId { get; set; }

    [Parameter]
    public EventCallback FetchMore { get; set; }

    private IJSObjectReference? _module;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            _module = await JsRuntime.InvokeAsync<IJSObjectReference>("import", "./observer.js");

            DotNetObjectReference<InfiniteScroll> objectRef = DotNetObjectReference.Create(this);
            await _module.InvokeVoidAsync("registerObserver", objectRef, ObserverTargetId);
        }
    }

    [JSInvokable]
    public async Task OnIntersection()
    {
        await FetchMore.InvokeAsync();
    }

    public async ValueTask DisposeAsync()
    {
        try
        {
            if (_module != null) await _module.DisposeAsync();
        }
        catch (JSDisconnectedException)
        {
            // Blazor Server: ignore if circuit already gone
        }
    }
}